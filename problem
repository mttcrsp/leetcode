#!/usr/bin/env swift

import Foundation

let arguments = CommandLine.arguments

guard arguments.count > 1 else {
  fatalError("USAGE: problem <url> <test_function_name>? <test_cases_count>?")
}

guard let url = URL(string: arguments[1]) else {
  fatalError("Expected a Leetcode problem URL to be provided as the first parameter.")
}

let testFunctionName: String
if arguments.count > 2 {
  testFunctionName = arguments[2]
} else {
  testFunctionName = "<#func#>"
}

let testCasesCount: Int
if arguments.count > 3, let count = Int(arguments[3]) {
  testCasesCount = count
} else {
  testCasesCount = 1
}
    
let fileManager = FileManager.default
let path = fileManager.currentDirectoryPath as NSString
let testsPath = path.appendingPathComponent("Tests")
let sourcesPath = path.appendingPathComponent("Sources")

guard fileManager.fileExists(atPath: testsPath)
    , fileManager.fileExists(atPath: sourcesPath) else {
  fatalError("Unable to locate the Sources/ and Tests/ folders. This script should be executed from the root of the project.")
}

let problemName = url.lastPathComponent

let sourceName = "\(problemName).swift"
let sourcePath = (sourcesPath as NSString).appendingPathComponent(sourceName)

let testName = "\(problemName)-tests.swift"
let testPath = (testsPath as NSString).appendingPathComponent(testName)
let testCases = (1 ... testCasesCount).map { i in
  """
    func test\(testFunctionName.capitalized)\(i)() {
      let input = 0
      let output = 0
      XCTAssertEqual(Solution().\(testFunctionName)(input), output)
    }
  """
}.joined(separator: "\n\n")

let testContents = Data("""
@testable
import Leetcode
import XCTest

extension SolutionTests {
\(testCases)
}
""".utf8)

guard fileManager.createFile(atPath: sourcePath, contents: nil)
    , fileManager.createFile(atPath: testPath, contents: testContents) else {
  fatalError("Unable to generate files for the specified problem.")
}

var process = Process()
process.launchPath = "/usr/bin/env"
process.arguments = ["xcodegen", "--quiet"]
process.launch()
process.waitUntilExit()

guard process.terminationStatus == 0 else {
  fatalError("Failed to regenerate Xcode project via Xcodegen.")
}

process = Process()
process.launchPath = "/usr/bin/env"
process.arguments = ["xed", "."]
process.launch()
process.waitUntilExit()
